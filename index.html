<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Musical Poll - Sequential Questions</title>
<script src="https://cdn.jsdelivr.net/npm/abcjs@6.1.2/dist/abcjs-basic-min.js"></script>
<style>
body { font-family: Arial; padding:20px; max-width:1000px; margin:auto; background:#f5f5f5; }
h2 { text-align:center; color:#333; }
button { padding:10px 20px; margin:5px; cursor:pointer; border:none; border-radius:6px; font-weight:bold; }
button:hover { transform:scale(1.05); box-shadow:0 4px 8px rgba(0,0,0,0.2); }
button:active { transform:scale(0.95); }
#poll-container, #results, #abc-notation { background:white; padding:20px; border-radius:10px; margin-bottom:20px; }
.vote-btn { margin:5px; }
.playback-controls { display:flex; gap:10px; margin:15px 0; flex-wrap:wrap; }
</style>
</head>
<body>

<h2>üéµ Musical Poll - Sequential Questions üéµ</h2>

<div id="poll-container">Loading first question...</div>

<div class="playback-controls">
  <button onclick="playAllNotes()" id="playBtn">‚ñ∂Ô∏è Play Melody</button>
  <button onclick="stopPlayback()" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
  <button onclick="resetPolls()" id="resetBtn" style="background:#f44336; color:white;">üîÑ Reset Polls</button>
</div>

<div id="abc-notation"></div>
<div id="notesSequence" style="font-family:monospace; margin-top:10px;">Melody will appear here...</div>

<h3>üìä Live Vote Results:</h3>
<div id="results">Loading...</div>

<script>
const API = "https://api.sarunas.lat"; // nomaini uz savu Worker URL

let polls = [];
let options = {};
let currentQuestionIndex = 0;
let melodyNotes = [];
let voterId = localStorage.getItem("voterId") || ('voter_'+Date.now());
localStorage.setItem("voterId", voterId);

let audioContext = null;
let abcSynth = null;
let visualObj = null;

/* ------------------ LOAD POLLS ------------------ */
async function loadPolls() {
  const res = await fetch(API+"/polls");
  polls = await res.json();
  for (let poll of polls) {
    const resOpt = await fetch(`${API}/options?poll_id=${poll.id}`);
    options[poll.id] = await resOpt.json();
  }
  currentQuestionIndex = 0;
  showQuestion();
  updateMusic();
  loadResults();
}

/* ------------------ SHOW SINGLE QUESTION ------------------ */
function showQuestion() {
  const container = document.getElementById("poll-container");
  if (currentQuestionIndex >= polls.length) {
    container.innerHTML = "<strong>All questions completed!</strong>";
    return;
  }
  const poll = polls[currentQuestionIndex];
  container.innerHTML = `<h3>Question #${poll.id}</h3>`;
  options[poll.id].forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "vote-btn";
    btn.textContent = opt.option_text;
    btn.onclick = ()=>submitVote(poll.id,opt.id,opt.option_text);
    container.appendChild(btn);
  });
}

/* ------------------ SUBMIT VOTE ------------------ */
async function submitVote(poll_id, option_id, noteText) {
  await fetch(API+"/vote", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({voter_id:voterId, poll_id, option_id})
  });
  melodyNotes.push(noteText);  // pievieno izvƒìlƒìto noti melodijai
  currentQuestionIndex++;
  showQuestion();
  updateMusic();
  loadResults();
}

/* ------------------ BUILD ABC ------------------ */
function buildABC() {
  const header = `X:1
T:Live Melody
M:4/4
L:1/4
K:C
`;
  const body = melodyNotes.map(n=>n+" |").join(" ");
  document.getElementById("notesSequence").textContent = melodyNotes.join(" | ");
  return header + (body||"z4 |");
}

function updateMusic() {
  const abc = buildABC();
  document.getElementById("abc-notation").innerHTML="";
  try {
    visualObj = ABCJS.renderAbc("abc-notation", abc)[0];
  } catch(e){console.error(e);}
}

/* ------------------ PLAYBACK ------------------ */
async function playAllNotes() {
  if (!melodyNotes.length) return;
  if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  if (!abcSynth) abcSynth = new ABCJS.synth.CreateSynth();

  const abc = buildABC();
  visualObj = ABCJS.renderAbc("abc-notation", abc)[0];

  await abcSynth.init({visualObj, audioContext});
  await abcSynth.prime();
  abcSynth.start();
  document.getElementById("playBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
}

function stopPlayback() {
  if (abcSynth) abcSynth.stop();
  document.getElementById("playBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
}

/* ------------------ RESET POLLS ------------------ */
async function resetPolls() {
  if(!confirm("Are you sure you want to reset all polls?")) return;
  await fetch(API+"/admin/reset", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({password:"YOUR_ADMIN_PASSWORD"})
  });
  melodyNotes = [];
  loadPolls();
}

/* ------------------ LIVE RESULTS ------------------ */
function loadResults() {
  let html = "";
  for (let poll of polls) {
    html += `<strong>Question #${poll.id}</strong><br>`;
    (options[poll.id]||[]).forEach(opt=>{
      html += `${opt.option_text} = ${opt.votes}<br>`;
    });
    html += "<br>";
  }
  document.getElementById("results").innerHTML = html || "No votes yet";
}

/* ------------------ INIT ------------------ */
loadPolls();
setInterval(loadResults, 3000); // atjauno rezultƒÅtus ik 3 sekundes

</script>
</body>
</html>
