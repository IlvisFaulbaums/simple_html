<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Musical Poll D1</title>
<script src="https://cdn.jsdelivr.net/npm/abcjs@6.1.2/dist/abcjs-basic-min.js"></script>
<style>
body { font-family: Arial; padding: 20px; max-width: 1000px; margin:auto; background:#f5f5f5; }
h2 { text-align:center; color:#333; }
button { padding:10px 20px; margin:5px; cursor:pointer; border:none; border-radius:6px; font-weight:bold; }
.vote-btn { margin:5px; padding:8px 12px; border-radius:6px; font-weight:bold; }
#abc-notation { background:#fff9e6; padding:20px; border-radius:8px; margin:15px 0; border:2px solid #4CAF50; min-height:150px; overflow-x:auto; }
#notesSequence { background:#333; color:white; padding:15px; border-radius:8px; margin:15px 0; font-family:monospace; font-size:18px; text-align:center; letter-spacing:5px; }
#poll-container { background:white; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); margin-bottom:20px; }
#results { margin-top:20px; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
#resetBtn { background:#f44336; color:white; }
</style>
</head>
<body>

<h2>üéµ Live Musical Poll (D1) üéµ</h2>

<div id="poll-container">Loading poll...</div>
<div>
<button id="resetBtn">‚ö†Ô∏è Reset All Votes</button>
</div>

<h3>üéº Current Melody</h3>
<div id="abc-notation"></div>
<div id="notesSequence">No notes yet</div>
<div id="results">Loading results...</div>

<script>
const API = "https://api.sarunas.lat"; // <--- nomaini uz savu Worker URL

let questions = [];
let currentQuestionIndex = 0;
let melodyNotes = [];
let voterId = localStorage.getItem("voterId");
if(!voterId){ voterId='voter_'+Date.now(); localStorage.setItem("voterId", voterId); }

let abcSynth = null;
let audioContext = null;
let visualObj = null;

// ------------------
// Load polls + options
// ------------------
async function loadPolls(){
  try{
    const res = await fetch(API+"/polls");
    const polls = await res.json();

    questions = [];
    for(let poll of polls){
      const optsRes = await fetch(API+"/options?poll_id="+poll.id);
      const options = await optsRes.json();
      questions.push({poll_id: poll.id, data_line: poll.data_line, options});
    }

    currentQuestionIndex = 0;
    showQuestion(currentQuestionIndex);
    updateMelody();
    showResults();
  }catch(e){console.error(e);}
}

// ------------------
// Show one question
// ------------------
function showQuestion(idx){
  const container = document.getElementById("poll-container");
  if(idx >= questions.length){
    container.innerHTML="<strong>All questions completed!</strong>";
    return;
  }
  const q = questions[idx];
  container.innerHTML = `<h3>Question ${q.poll_id}</h3>`;
  q.options.forEach(opt=>{
    const btn = document.createElement("button");
    btn.className="vote-btn";
    btn.textContent = opt.option_text+" ("+opt.votes+")";
    btn.onclick = async ()=>{
      await vote(q.poll_id,opt.id,opt.option_text);
      currentQuestionIndex++;
      showQuestion(currentQuestionIndex);
    };
    container.appendChild(btn);
  });
}

// ------------------
// Vote
// ------------------
async function vote(poll_id, option_id, note){
  try{
    await fetch(API+"/vote",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({voter_id:voterId,poll_id,option_id})
    });
    melodyNotes.push(note);
    updateMelody();
    playLastNote(note);
    loadPolls(); // refresh counts
  }catch(e){console.error(e);}
}

// ------------------
// Reset votes
// ------------------
document.getElementById("resetBtn").onclick = async ()=>{
  const pwd = prompt("Enter admin password:");
  if(!pwd) return;
  try{
    await fetch(API+"/admin/reset",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({password:pwd})
    });
    melodyNotes=[];
    currentQuestionIndex=0;
    await loadPolls();
    alert("All votes reset!");
  }catch(e){console.error(e);}
}

// ------------------
// Update ABCJS melody
// ------------------
function updateMelody(){
  if(!melodyNotes.length){ document.getElementById("notesSequence").textContent="No notes yet"; document.getElementById("abc-notation").innerHTML=""; return; }
  const header=
`X:1
T:Live Melody
M:4/4
L:1/4
Q:1/4=120
K:C
`;
  const body = melodyNotes.join(" ");
  document.getElementById("notesSequence").textContent = melodyNotes.join(" | ");
  document.getElementById("abc-notation").innerHTML="";
  try{
    visualObj = ABCJS.renderAbc("abc-notation", header+body)[0];
  }catch(e){console.error(e);}
}

// ------------------
// Play last voted note
// ------------------
async function playLastNote(note){
  if(!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)();
  if(!abcSynth) abcSynth = new ABCJS.synth.CreateSynth();
  const abcStr =
`X:1
T:Last Note
M:4/4
L:1/4
Q:1/4=120
K:C
` + note;
  visualObj = ABCJS.renderAbc("abc-notation", abcStr)[0];
  try{
    await abcSynth.init({visualObj,audioContext});
    await abcSynth.prime();
    abcSynth.start();
  }catch(e){console.error(e);}
}

// ------------------
// Show vote results
// ------------------
function showResults(){
  const resContainer = document.getElementById("results");
  let html="";
  for(let q of questions){
    html+=`<strong>Question ${q.poll_id}</strong><br>`;
    for(let opt of q.options){
      html+=`${opt.option_text} = ${opt.votes}<br>`;
    }
    html+="<br>";
  }
  resContainer.innerHTML = html || "No votes yet";
}

// ------------------
// Init
// ------------------
loadPolls();
setInterval(loadPolls,5000);
</script>

</body>
</html>
