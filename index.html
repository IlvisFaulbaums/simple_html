<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Melody Poll</title>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.1.2/dist/abcjs-basic-min.js"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        #app-card { background: white; width: 100%; max-width: 550px; padding: 30px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); position: relative; margin-bottom: 20px; }
        
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; border-radius: 24px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; transition: opacity 0.5s ease; }
        
        .status-text { text-align: center; color: #1877f2; font-weight: bold; margin-bottom: 25px; height: 24px; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1.5px; }

        .option-item {
            border: 2px solid #e4e6eb; border-radius: 16px; margin-bottom: 15px;
            padding: 15px; background: #fff; transition: all 0.3s ease;
            opacity: 0.3; pointer-events: none;
        }
        
        .is-playing { opacity: 1; border-color: #42b72a; background: #f6ffed; transform: scale(1.02); }
        .is-played { border-color: #f7b928; opacity: 0.7; }
        .can-vote { opacity: 1; pointer-events: auto; cursor: pointer; border-color: #1877f2; }
        .can-vote:hover { background: #f0f7ff; transform: translateY(-2px); border-width: 3px; }

        .notation-slot { width: 100%; min-height: 100px; }
        .progress-track { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: #42b72a; width: 0%; }

        .primary-btn { background: #1877f2; color: white; border: none; padding: 20px 50px; border-radius: 40px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }

        /* Results Section */
        #results-frame { background: white; width: 100%; max-width: 550px; padding: 25px; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .results-header { font-weight: bold; color: #65676b; font-size: 0.9rem; margin-bottom: 15px; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #winning-melody-svg { width: 100%; min-height: 100px; }
    </style>
</head>
<body>

<div id="app-card">
    <div id="overlay">
        <h2>üéµ Ready to Vote?</h2>
        <p style="color: #65676b; margin-bottom: 30px;">Options play automatically.</p>
        <button class="primary-btn" onclick="startApp()">Enter Poll</button>
    </div>

    <h2 style="text-align: center;">Sequence Poll</h2>
    <div id="status" class="status-text">Connecting...</div>
    <div id="options-list"></div>
</div>

<div id="results-frame">
    <div class="results-header">üèÜ CURRENT WINNING MELODY (LIVE)</div>
    <div id="winning-melody-svg"></div>
</div>

<script>
    const API = "https://api.sarunas.lat";
    const SOUNDFONT = "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/";
    const SEC_PER_UNIT = 0.25; // C1=1/8 @ 120BPM

    let audioCtx = null;
    let pollData = [];
    let currentIdx = 0;
    let currentUI = [];
    let activeSynth = null;

    // 1. Fetch Polls & Refresh Results
    async function updateData() {
        try {
            const res = await fetch(API + "/polls");
            const data = await res.json();
            
            // Group by question_id
            const grouped = data.reduce((acc, obj) => {
                if (!acc[obj.question_id]) acc[obj.question_id] = { id: obj.question_id, opts: [] };
                acc[obj.question_id].opts.push(obj);
                return acc;
            }, {});
            
            pollData = Object.values(grouped);
            renderWinningMelody(pollData);
        } catch (e) { console.error("API error", e); }
    }

    // 2. Render Winning Melody Frame
    function renderWinningMelody(data) {
        let fullWinningAbc = "X:1\nT:Community Masterpiece\nM:4/4\nL:1/8\nQ:1/4=120\nK:C\n";
        let melodyPath = "";

        // For each question, find the option with the highest count
        data.forEach(question => {
            let winner = question.opts.reduce((prev, current) => 
                (prev.count > current.count) ? prev : current
            );
            
            if (winner.count > 0) {
                melodyPath += winner.option + " | ";
            }
        });

        if (melodyPath === "") melodyPath = "z8"; // Rest if no votes
        ABCJS.renderAbc("winning-melody-svg", fullWinningAbc + melodyPath, { responsive: "resize", scale: 0.9 });
    }

    // 3. Calculation for playback
    function getDuration(abc) {
        const clean = abc.replace(/[|\[\]\s]/g, '');
        const pattern = /([A-Ga-gz][',]*)(\d*)/g;
        let units = 0, m;
        while ((m = pattern.exec(clean)) !== null) {
            units += (m[2] === "") ? 1 : parseInt(m[2]);
        }
        return units * SEC_PER_UNIT;
    }

    // 4. Start Application
    async function startApp() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        
        document.getElementById('overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('overlay').style.display = 'none', 500);
        
        loadAndPlayCurrent();
    }

    // 5. Load UI and Sequential Play
    function loadAndPlayCurrent() {
        const list = document.getElementById('options-list');
        const status = document.getElementById('status');
        list.innerHTML = '';
        currentUI = [];

        if (currentIdx >= pollData.length) {
            status.innerText = "All Polls Done!";
            return;
        }

        const q = pollData[currentIdx];
        status.innerText = "üéß Listening...";

        q.opts.forEach((opt, i) => {
            const div = document.createElement('div');
            div.className = 'option-item';
            const svgId = `svg-${i}`, barId = `bar-${i}`;
            
            div.innerHTML = `<div id="${svgId}" class="notation-slot"></div><div class="progress-track"><div id="${barId}" class="progress-fill"></div></div>`;
            list.appendChild(div);

            const abcText = opt.option;
            const fullAbc = `X:1\nM:4/4\nL:1/8\nQ:1/4=120\nK:C\n${abcText}`;
            const visualObj = ABCJS.renderAbc(svgId, fullAbc, { staffwidth: 450, scale: 0.85 })[0];
            
            currentUI.push({ visualObj, abcText, barId, duration: getDuration(abcText), el: div });
        });

        triggerSequence(0);
    }

    function triggerSequence(index) {
        if (index >= currentUI.length) {
            unlockVoting();
            return;
        }

        const task = currentUI[index];
        if (activeSynth) { activeSynth.stop(); activeSynth = null; }

        task.el.classList.add('is-playing');
        activeSynth = new ABCJS.synth.CreateSynth();

        activeSynth.init({ visualObj: task.visualObj, audioContext: audioCtx, options: { soundFontUrl: SOUNDFONT } })
        .then(() => activeSynth.prime())
        .then(() => {
            const bar = document.getElementById(task.barId);
            bar.style.transition = `width ${task.duration}s linear`;
            bar.style.width = "100%";
            activeSynth.start();

            setTimeout(() => {
                if (activeSynth) activeSynth.stop();
                task.el.classList.remove('is-playing');
                task.el.classList.add('is-played');
                setTimeout(() => triggerSequence(index + 1), 200);
            }, task.duration * 1000);
        });
    }

    function unlockVoting() {
        document.getElementById('status').innerText = "Select your favorite";
        currentUI.forEach(item => {
            item.el.classList.remove('is-played');
            item.el.classList.add('can-vote');
            item.el.onclick = () => castVote(item.abcText);
        });
    }

    async function castVote(val) {
        currentUI.forEach(i => i.el.onclick = null);
        document.getElementById('status').innerText = "Voting...";

        const vId = localStorage.getItem('voterId') || 'v_' + Math.random().toString(36).substr(2,9);
        localStorage.setItem('voterId', vId);

        try {
            await fetch(API + "/vote", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ voter_id: vId, question_id: pollData[currentIdx].id, option: val })
            });

            currentIdx++;
            await updateData(); // Refresh winning melody after vote
            loadAndPlayCurrent();
        } catch (e) {
            alert("Connection error");
            unlockVoting();
        }
    }

    // Start background fetching
    updateData();
    setInterval(updateData, 5000); // Live updates every 5s
</script>

</body>
</html>
