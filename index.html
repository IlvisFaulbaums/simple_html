<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Musical Poll with D1</title>
<script src="https://cdn.jsdelivr.net/npm/abcjs@6.1.2/dist/abcjs-basic-min.js"></script>
<style>
body { font-family: Arial; padding:20px; max-width:1000px; margin:auto; background:#f5f5f5; }
h2 { text-align:center; color:#333; }
button { padding:10px 20px; margin:5px; cursor:pointer; border:none; border-radius:6px; font-weight:bold; }
button:hover { transform:scale(1.05); box-shadow:0 4px 8px rgba(0,0,0,0.2); }
button:active { transform:scale(0.95); }
#poll-container, #results, #abc-notation { background:white; padding:20px; border-radius:10px; margin-bottom:20px; }
.vote-btn { margin:5px; }
.playback-controls { display:flex; gap:10px; margin:15px 0; flex-wrap:wrap; }
</style>
</head>
<body>

<h2>üéµ Musical Poll - Play All Database Notes üéµ</h2>

<div id="poll-container">Loading polls...</div>

<div id="music-section">
  <h3>üéº ABCJS Notation & Playback</h3>
  <div class="playback-controls">
    <button onclick="playAllNotes()" id="playBtn">‚ñ∂Ô∏è Play ALL Notes</button>
    <button onclick="stopPlayback()" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
  </div>
  <div id="abc-notation"></div>
  <div id="notesSequence" style="font-family:monospace; margin-top:10px;">No notes yet</div>
</div>

<h3>üìä Current Vote Results:</h3>
<div id="results">Loading results...</div>

<script>
const API = "https://YOUR_CLOUDFLARE_WORKER_URL"; // nomaini uz savu Worker URL

let currentPolls = [];
let currentOptions = {};
let voterId = localStorage.getItem("voterId") || ('voter_'+Date.now());
localStorage.setItem("voterId", voterId);

let audioContext = null;
let abcSynth = null;
let visualObj = null;

/* ------------------ LOAD POLLS ------------------ */
async function loadPolls() {
  const res = await fetch(API+"/polls");
  const polls = await res.json();
  currentPolls = polls;
  renderPolls();
}

async function loadOptions(poll_id) {
  const res = await fetch(`${API}/options?poll_id=${poll_id}`);
  const options = await res.json();
  currentOptions[poll_id] = options;
  return options;
}

/* ------------------ RENDER POLLS ------------------ */
async function renderPolls() {
  const container = document.getElementById("poll-container");
  container.innerHTML = "";
  for (let poll of currentPolls) {
    const box = document.createElement("div");
    box.innerHTML = `<h3>Poll #${poll.id}</h3>`;
    const opts = await loadOptions(poll.id);
    for (let opt of opts) {
      const btn = document.createElement("button");
      btn.className = "vote-btn";
      btn.textContent = opt.option_text;
      btn.onclick = ()=>vote(poll.id,opt.id);
      box.appendChild(btn);
    }
    container.appendChild(box);
  }
  updateMusic();
  loadResults();
}

/* ------------------ VOTE ------------------ */
async function vote(poll_id, option_id) {
  await fetch(API+"/vote", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({voter_id:voterId,poll_id,poll_id,option_id})
  });
  loadPolls();
}

/* ------------------ LOAD RESULTS ------------------ */
async function loadResults() {
  let html = "";
  for (let poll of currentPolls) {
    html += `<strong>Poll #${poll.id}</strong><br>`;
    const opts = currentOptions[poll.id] || [];
    for (let opt of opts) {
      html += `${opt.option_text} = ${opt.votes}<br>`;
    }
    html += "<br>";
  }
  document.getElementById("results").innerHTML = html || "No votes yet";
}

/* ------------------ ABCJS & PLAYBACK ------------------ */
function parseNotesFromOptions() {
  let notes = [];
  for (let poll of currentPolls) {
    const opts = currentOptions[poll.id] || [];
    for (let opt of opts) {
      for(let i=0;i<opt.votes;i++) {
        notes.push(opt.option_text);
      }
    }
  }
  return notes;
}

function buildABCString() {
  const header = `X:1
T:All Database Notes
M:4/4
L:1/4
K:C
`;
  const notes = parseNotesFromOptions();
  let body = notes.map(n=>n+" |").join(" ");
  if (!body) body="z4 |";
  document.getElementById("notesSequence").textContent = notes.join(" | ");
  return header + body;
}

function updateMusic() {
  const abc = buildABCString();
  document.getElementById("abc-notation").innerHTML="";
  try {
    visualObj = ABCJS.renderAbc("abc-notation", abc)[0];
  } catch(e){console.error(e);}
}

/* ------------------ PLAYBACK ------------------ */
async function playAllNotes() {
  if (!currentPolls.length) return;
  if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  if (!abcSynth) abcSynth = new ABCJS.synth.CreateSynth();

  const abc = buildABCString();
  visualObj = ABCJS.renderAbc("abc-notation", abc)[0];

  await abcSynth.init({visualObj, audioContext});
  await abcSynth.prime();
  abcSynth.start();
  document.getElementById("playBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
}

function stopPlayback() {
  if (abcSynth) abcSynth.stop();
  document.getElementById("playBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
}

/* ------------------ INIT ------------------ */
loadPolls();
setInterval(loadPolls,5000);
</script>

</body>
</html>
