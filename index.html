<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Poll with Music</title>
<style>
@font-face {
  font-family: 'MusiQwik';
  src: url('musiqwik.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

body { font-family: Arial; padding: 20px; max-width: 600px; margin: auto; }
h2 { text-align: center; }
button { padding: 8px 15px; margin: 5px; cursor: pointer; transition: all 0.2s; }
button:hover { transform: scale(1.05); }
button:active { transform: scale(0.95); }
#results { margin-top: 20px; }
#admin-section { 
  margin-top: 30px; 
  border-top: 2px solid #ccc; 
  padding-top: 20px;
}
#admin-results {
  font-family: 'MusiQwik', Arial, sans-serif;
  font-size: 18px;
  line-height: 1.6;
  padding: 15px;
  background: #f9f9f9;
  border-radius: 5px;
  margin-top: 10px;
}
.vote-btn {
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  font-weight: bold;
}
.vote-btn:hover {
  background: #45a049;
}
.admin-btn {
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 4px;
}
.musical-note {
  font-size: 24px;
  margin-right: 5px;
}
</style>
</head>
<body>

<h2>ðŸŽµ Vote on the Musical Poll ðŸŽµ</h2>
<div id="poll-container"></div>

<h3>Results:</h3>
<div id="results">Loading results...</div>

<div id="admin-section">
  <h3>ðŸŽ¼ Admin Results (MusiQwik Font) ðŸŽ¼</h3>
  <button class="admin-btn" onclick="showAdminResults()">Show Admin Results</button>
  <div id="admin-results"></div>
</div>

<script>
const API = "https://api.sarunas.lat"; // Your Worker URL

// Audio context for playing notes
let audioContext = null;

// Generate a random voter ID for simplicity (or use login/session)
let voterId = localStorage.getItem("voterId");
if (!voterId) {
  voterId = 'voter_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  localStorage.setItem("voterId", voterId);
}

// Musical notes frequency mapping (solfÃ¨ge to frequency)
const noteFrequencyMap = {
  'DO': 261.63,  // C4
  'RE': 293.66,  // D4
  'MI': 329.63,  // E4
  'FA': 349.23,  // F4
  'SOL': 392.00, // G4
  'LA': 440.00,  // A4
  'SI': 493.88   // B4
};

// Musical note symbols for display
const noteSymbolMap = {
  'DO': 'ð…',  // Whole note
  'RE': 'ð…ž',  // Half note
  'MI': 'ð…Ÿ',  // Quarter note
  'FA': 'ð… ',  // Eighth note
  'SOL': 'ð…¡', // Sixteenth note
  'LA': 'ð…¢',  // Thirty-second note
  'SI': 'ð…£'   // Sixty-fourth note
};

// Function to play a musical note
async function playNote(noteName) {
  try {
    // Initialize audio context on first use
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      await audioContext.resume();
    }

    // Get frequency for the note (default to 440Hz if not found)
    const frequency = noteFrequencyMap[noteName] || 440.00;

    // Create and play the note
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.type = 'sine';
    oscillator.frequency.value = frequency;
    
    // Envelope for a nice note sound
    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
    gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.3);
    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1);
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 1);
    
    console.log(`Playing note: ${noteName} (${frequency}Hz)`);
    
  } catch (error) {
    console.log("Audio play failed:", error);
  }
}

// Load questions dynamically
async function loadQuestions() {
  const res = await fetch(API + "/results");
  const data = await res.json();

  // Group by question
  const questions = {};
  data.forEach(item => {
    if (!questions[item.question_id]) questions[item.question_id] = [];
    questions[item.question_id].push(item.option);
  });

  const container = document.getElementById("poll-container");
  container.innerHTML = "";

  for (const qid in questions) {
    const div = document.createElement("div");
    div.innerHTML = `<h3>Question ${qid}</h3>`;
    questions[qid].forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "vote-btn";
      btn.innerText = opt;
      // Add a musical note emoji based on the option
      const noteEmoji = getNoteEmoji(opt);
      btn.innerHTML = `${noteEmoji} ${opt}`;
      btn.onclick = () => vote(qid, opt);
      div.appendChild(btn);
    });
    container.appendChild(div);
  }

  loadResults();
}

// Helper function to get emoji for note
function getNoteEmoji(note) {
  const emojiMap = {
    'DO': 'ðŸŽµ',
    'RE': 'ðŸŽ¶',
    'MI': 'ðŸŽµ',
    'FA': 'ðŸŽ¶',
    'SOL': 'ðŸŽµ',
    'LA': 'ðŸŽ¶',
    'SI': 'ðŸŽµ'
  };
  return emojiMap[note] || 'ðŸŽµ';
}

// Vote function with note playing
async function vote(questionId, option) {
  // Play the musical note from the option (DO, RE, MI, etc.)
  await playNote(option);
  
  const res = await fetch(API + "/vote", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ voter_id: voterId, question_id: questionId, option })
  });

  const data = await res.json();
  if (data.error) alert(data.error);
  loadResults();
}

// Load live results
async function loadResults() {
  const res = await fetch(API + "/results");
  const data = await res.json();

  // Group results by question
  const grouped = {};
  data.forEach(v => {
    if (!grouped[v.question_id]) grouped[v.question_id] = [];
    grouped[v.question_id].push(v);
  });

  let text = "";
  for (const qid in grouped) {
    text += `Question ${qid}: `;
    grouped[qid].forEach(o => { text += `${o.option}=${o.count} | `; });
    text += "\n";
  }
  document.getElementById("results").innerText = text;
}

// Show admin results with MusiQwik font
async function showAdminResults() {
  const res = await fetch(API + "/results");
  const data = await res.json();

  // Group results by question
  const grouped = {};
  data.forEach(v => {
    if (!grouped[v.question_id]) grouped[v.question_id] = [];
    grouped[v.question_id].push(v);
  });

  let adminText = "<div style='font-family: MusiQwik, Arial;'>";
  
  for (const qid in grouped) {
    adminText += `<div style="margin-bottom: 20px;">`;
    adminText += `<div style="font-family: Arial; font-weight: bold; font-size: 20px;">ðŸŽ¼ Question ${qid}:</div>`;
    
    // Sort options by count for better visualization
    grouped[qid].sort((a, b) => b.count - a.count);
    
    grouped[qid].forEach(o => { 
      // Create a musical staff representation
      const noteSymbol = noteSymbolMap[o.option] || 'â™ª';
      const notes = noteSymbol.repeat(Math.min(o.count, 8)); // Max 8 notes per line
      
      adminText += `<div style="margin: 10px 0; font-size: 24px;">`;
      adminText += `<span style="font-family: Arial; font-size: 16px;">${o.option}:</span> `;
      adminText += `<span style="font-size: 28px;">${notes}</span>`;
      adminText += `<span style="font-family: Arial; font-size: 14px; margin-left: 10px;">(${o.count} votes)</span>`;
      adminText += `</div>`;
    });
    
    adminText += `</div>`;
  }
  
  // Add a musical staff summary
  adminText += `<div style="margin-top: 30px; border-top: 2px solid #333; padding-top: 20px;">`;
  adminText += `<div style="font-family: Arial; font-weight: bold;">ðŸŽµ Musical Score Summary:</div>`;
  adminText += `<div style="font-family: MusiQwik; font-size: 32px; line-height: 1.8;">`;
  
  // Create a melody from all votes
  const allNotes = [];
  data.forEach(v => {
    for (let i = 0; i < v.count; i++) {
      allNotes.push(v.option);
    }
  });
  
  // Display first 16 notes as a melody
  const melodyNotes = allNotes.slice(0, 16);
  melodyNotes.forEach(note => {
    adminText += noteSymbolMap[note] || 'â™ª';
    adminText += ' ';
  });
  
  if (allNotes.length > 16) {
    adminText += ' â€¦';
  }
  
  adminText += `</div>`;
  adminText += `<div style="font-family: Arial; font-size: 14px; margin-top: 10px;">Total votes: ${allNotes.length}</div>`;
  adminText += `</div>`;
  
  adminText += "</div>";
  
  document.getElementById("admin-results").innerHTML = adminText;
}

// Auto-refresh every 5 seconds
setInterval(loadResults, 5000);

// Initial load
loadQuestions();

// Initialize audio context on first user interaction
document.addEventListener('click', async function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    await audioContext.resume();
    document.removeEventListener('click', initAudio);
  }
}, { once: true });
</script>
</body>
</html>
