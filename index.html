<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuzikƒÅlƒÅ Aptauja</title>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.1.2/dist/abcjs-basic-min.js"></script>
    <style>
        :root {
            --primary: #1877f2;
            --success: #42b72a;
            --warning: #f7b928;
            --danger: #ff4d4d;
            --bg: #f0f2f5;
            --text: #1c1e21;
            --text-secondary: #65676b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            padding: 10px; background: var(--bg); 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; margin: 0; color: var(--text);
        }

        #app-card, #results-frame { 
            background: white; width: 100%; max-width: 600px; 
            padding: 20px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            position: relative; margin-bottom: 20px;
        }

        #overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; border-radius: 20px; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; padding: 20px;
        }
        
        .status-text { 
            text-align: center; color: var(--primary); font-weight: bold; 
            margin-bottom: 20px; height: 24px; text-transform: uppercase; 
            font-size: 0.75rem; letter-spacing: 1.2px; 
        }

        .option-item {
            border: 2px solid #e4e6eb; border-radius: 16px; margin-bottom: 12px;
            padding: 12px; background: #fff; transition: opacity 0.3s;
            opacity: 0.3; pointer-events: none; position: relative;
        }
        
        .is-playing { opacity: 1; border-color: var(--success); background: #f6ffed; }
        .is-played { border-color: var(--warning); opacity: 0.7; }
        .can-vote { opacity: 1; pointer-events: auto; cursor: pointer; border-color: var(--primary); }
        .can-vote:hover { background: #f0f7ff; }

        .vote-badge {
            position: absolute; top: 10px; right: 15px;
            background: #f0f2f5; padding: 4px 10px; border-radius: 20px;
            font-size: 0.75rem; font-weight: bold; color: var(--text-secondary);
            border: 1px solid #ddd; z-index: 5;
        }

        .notation-slot { width: 100%; min-height: 80px; }
        .progress-track { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: none; }

        .primary-btn { 
            background: var(--primary); color: white; border: none; 
            padding: 16px 32px; border-radius: 40px; font-weight: bold; 
            font-size: 1.1rem; cursor: pointer; width: 80%; max-width: 300px;
        }

        .results-header { 
            font-weight: bold; color: var(--text-secondary); font-size: 0.8rem; 
            margin-bottom: 15px; text-align: center; border-bottom: 1px solid #eee; 
            padding-bottom: 10px;
        }

        #winning-melody-svg { width: 100%; min-height: 100px; }
        .final-play-container { text-align: center; margin-top: 20px; display: none; }
        .reset-btn { background: none; color: var(--text-secondary); border: 1px solid #ddd; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.7rem; margin-top: 20px; }
    </style>
</head>
<body>

<div id="app-card">
    <div id="overlay">
        <h2>üéµ Vai esi gatavs?</h2>
        <p style="color: var(--text-secondary); margin-bottom: 30px;">Melodijas tiks atska≈Üotas automƒÅtiski.</p>
        <button class="primary-btn" onclick="startApp()">SƒÅkt aptauju</button>
    </div>
    <h2 style="text-align: center;">MuzikƒÅlƒÅ aptauja</h2>
    <div id="status" class="status-text">IelƒÅdƒì...</div>
    <div id="options-list"></div>
</div>

<div id="results-frame">
    <div class="results-header">üèÜ KOPƒ™GƒÄ MELODIJA (TIE≈†RAIDE)</div>
    <div id="winning-melody-svg"></div>
    <div id="final-playback" class="final-play-container">
        <button class="primary-btn" onclick="playFinalMelody()">‚ñ∂ Atska≈Üot rezultƒÅtu</button>
    </div>
</div>

<button class="reset-btn" onclick="adminReset()">‚ö†Ô∏è ADMIN: ATIESTATƒ™T</button>

<script>
    const API = "https://api.sarunas.lat";
    const SOUNDFONT = "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/";
    
    // TEMPO KONFIGURƒÄCIJA: 120 BPM
    const BPM = 120;
    const SEC_PER_UNIT = 0.25; // Ja L:1/8, tad 1 vienƒ´ba = 0.25 sekundes pie 120 BPM

    let audioCtx = null;
    let pollData = [];
    let currentIdx = 0;
    let currentUI = [];
    let activeSynth = null;
    let finalVisualObj = null;

    async function updateData() {
        try {
            const res = await fetch(API + "/polls");
            const data = await res.json();
            const grouped = data.reduce((acc, obj) => {
                if (!acc[obj.question_id]) acc[obj.question_id] = { id: obj.question_id, opts: [] };
                acc[obj.question_id].opts.push(obj);
                return acc;
            }, {});
            pollData = Object.values(grouped);
            renderWinningMelody(pollData);
            
            if (currentUI.length > 0 && pollData[currentIdx]) {
                pollData[currentIdx].opts.forEach((opt, i) => {
                    const b = document.getElementById(`badge-${i}`);
                    if (b) b.innerText = `${opt.count} balsis`;
                });
            }
            if (pollData.length > 0 && currentIdx >= pollData.length) showFinalView();
        } catch (e) { console.error(e); }
    }

    function renderWinningMelody(data) {
        let abc = `X:1\nM:4/4\nL:1/8\nQ:1/4=${BPM}\nK:C\n`;
        let path = "";
        data.forEach(q => {
            let w = q.opts.reduce((a, b) => (a.count > b.count ? a : b));
            if (w && w.count > 0) path += w.option + " | ";
        });
        const v = ABCJS.renderAbc("winning-melody-svg", abc + (path || "z8"), { responsive: "resize" });
        finalVisualObj = v[0];
    }

    function showFinalView() {
        document.getElementById('app-card').style.display = 'none';
        document.getElementById('final-playback').style.display = 'block';
    }

    function getDuration(abc) {
        const clean = abc.replace(/"[^"]*"/g, '').replace(/[|\[\]\s\n\r]/g, '');
        const pattern = /([A-Ga-gz][',]*)(\d*)/g;
        let units = 0, m;
        while ((m = pattern.exec(clean)) !== null) {
            units += (m[2] === "") ? 1 : parseInt(m[2]);
        }
        return units * SEC_PER_UNIT;
    }

    async function startApp() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        document.getElementById('overlay').style.display = 'none';
        loadAndPlayCurrent();
    }

    function loadAndPlayCurrent() {
        if (pollData.length > 0 && currentIdx >= pollData.length) {
            showFinalView();
            return;
        }
        const list = document.getElementById('options-list');
        const status = document.getElementById('status');
        list.innerHTML = '';
        currentUI = [];
        if (!pollData[currentIdx]) return;

        const q = pollData[currentIdx];
        status.innerText = "üéß Atska≈Üo melodijas...";

        q.opts.forEach((opt, i) => {
            const div = document.createElement('div');
            div.className = 'option-item';
            div.innerHTML = `
                <div class="vote-badge" id="badge-${i}">${opt.count} balsis</div>
                <div id="svg-${i}" class="notation-slot"></div>
                <div class="progress-track"><div id="fill-${i}" class="progress-fill"></div></div>
            `;
            list.appendChild(div);
            
            // PIEVIENOTS TEMPO Q:1/4=120 katrai pogai
            const fullAbc = `X:1\nM:4/4\nL:1/8\nQ:1/4=${BPM}\nK:C\n${opt.option}`;
            const visual = ABCJS.renderAbc(`svg-${i}`, fullAbc, { responsive: "resize", scale: 0.8 })[0];
            currentUI.push({ visual, abc: opt.option, fillId: `fill-${i}`, duration: getDuration(opt.option), el: div });
        });
        setTimeout(() => triggerSequence(0), 100);
    }

    function triggerSequence(idx) {
        if (idx >= currentUI.length) { unlockVoting(); return; }
        const task = currentUI[idx];
        if (activeSynth) { activeSynth.stop(); activeSynth = null; }

        task.el.classList.add('is-playing');
        activeSynth = new ABCJS.synth.CreateSynth();
        activeSynth.init({ visualObj: task.visual, audioContext: audioCtx, options: { soundFontUrl: SOUNDFONT } })
        .then(() => activeSynth.prime())
        .then(() => {
            const bar = document.getElementById(task.fillId);
            bar.style.transition = 'none';
            bar.style.width = '0%';
            void bar.offsetWidth; 

            activeSynth.start();

            bar.style.transition = `width ${task.duration}s linear`;
            bar.style.width = '100%';

            setTimeout(() => {
                if (activeSynth) activeSynth.stop();
                task.el.classList.remove('is-playing');
                task.el.classList.add('is-played');
                setTimeout(() => triggerSequence(idx + 1), 200);
            }, task.duration * 1000);
        });
    }

    function unlockVoting() {
        document.getElementById('status').innerText = "Izvƒìlies savu favorƒ´tu";
        currentUI.forEach(item => {
            item.el.classList.remove('is-played');
            item.el.classList.add('can-vote');
            item.el.onclick = () => castVote(item.abc);
        });
    }

    async function castVote(val) {
        currentUI.forEach(i => i.el.onclick = null);
        if (activeSynth) activeSynth.stop();
        const qId = pollData[currentIdx].id;
        currentIdx++;
        loadAndPlayCurrent();
        let vId = localStorage.getItem('voterId') || 'v_' + Math.random().toString(36).substr(2,9);
        localStorage.setItem('voterId', vId);
        fetch(API + "/vote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ voter_id: vId, question_id: qId, option: val })
        }).then(() => updateData());
    }

    async function playFinalMelody() {
        if (!finalVisualObj) return;
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        activeSynth = new ABCJS.synth.CreateSynth();
        activeSynth.init({ visualObj: finalVisualObj, audioContext: audioCtx, options: { soundFontUrl: SOUNDFONT } })
        .then(() => activeSynth.prime()).then(() => activeSynth.start());
    }

    function adminReset() {
        const p = prompt("Admin parole:");
        if (!p) return;
        fetch(API + "/admin/reset", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({password:p})})
        .then(() => {
            localStorage.removeItem('voterId');
            location.reload();
        });
    }

    updateData();
    setInterval(updateData, 8000);
</script>
</body>
</html>
