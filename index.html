<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Musical Poll</title>
<script src="https://cdn.jsdelivr.net/npm/abcjs@6.1.2/dist/abcjs-basic-min.js"></script>
<style>
body { font-family: Arial; padding: 20px; max-width: 1000px; margin: auto; background: #f5f5f5; }
h2 { text-align: center; color: #333; }
button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; }
button:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
button:active { transform: scale(0.95); }
.vote-btn { margin: 5px; padding: 8px 12px; border-radius: 6px; font-weight: bold; }
#abc-notation { background: #fff9e6; padding: 20px; border-radius: 8px; margin: 15px 0; border: 2px solid #4CAF50; min-height: 150px; overflow-x: auto; }
#notesSequence { background: #333; color: white; padding: 15px; border-radius: 8px; margin: 15px 0; font-family: monospace; font-size: 18px; text-align: center; letter-spacing: 5px; }
#poll-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
#results { margin-top: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
#resetBtn { background: #f44336; color: white; }
</style>
</head>
<body>

<h2>üéµ Live Musical Poll üéµ</h2>

<div id="poll-container">
  Loading question...
</div>

<div>
  <button id="resetBtn">‚ö†Ô∏è Reset All Votes (Admin)</button>
</div>

<h3>üéº Current Melody from Votes</h3>
<div id="abc-notation"></div>
<div id="notesSequence">No notes yet</div>
<div id="results">Loading results...</div>

<script>
const API = "https://YOUR_WORKER_URL"; // <--- nomaini uz savu Worker URL
let currentQuestionIndex = 0;
let questions = [];
let currentVoteData = [];
let voterId = localStorage.getItem("voterId");
if(!voterId) { voterId = 'voter_' + Date.now(); localStorage.setItem("voterId", voterId); }

let abcSynth = null;
let audioContext = null;
let visualObj = null;

function safeArray(data) {
  if(!Array.isArray(data)) return [];
  return data.map(item=>({question_id: item.question_id??0, option: item.option??"", count: parseInt(item.count??0)}));
}

// ----------------------------
// Load polls from Worker
// ----------------------------
async function loadPolls() {
  try {
    const res = await fetch(API+"/polls");
    const raw = await res.json();
    const data = safeArray(raw);

    // Group by question
    const grouped = {};
    data.forEach(v=>{
      if(!grouped[v.question_id]) grouped[v.question_id]=[];
      grouped[v.question_id].push(v);
    });

    questions = Object.keys(grouped).map(qid => ({question_id: qid, options: grouped[qid]}));
    currentVoteData = data;
    showQuestion(currentQuestionIndex);
    updateMelody();
    showResults();
  } catch(e) {
    console.error(e);
    document.getElementById("poll-container").innerHTML = "Failed to load polls";
  }
}

// ----------------------------
// Show one question at a time
// ----------------------------
function showQuestion(idx){
  const container = document.getElementById("poll-container");
  if(idx >= questions.length){
    container.innerHTML = "<strong>All questions completed!</strong>";
    return;
  }
  const q = questions[idx];
  container.innerHTML = `<h3>Question ${q.question_id}</h3>`;
  q.options.forEach(opt=>{
    const btn = document.createElement("button");
    btn.className = "vote-btn";
    btn.textContent = opt.option + ` (${opt.count})`;
    btn.onclick = async ()=>{
      await vote(q.question_id, opt.option);
      currentQuestionIndex++;
      showQuestion(currentQuestionIndex);
    };
    container.appendChild(btn);
  });
}

// ----------------------------
// Vote for an option
// ----------------------------
async function vote(qid,opt){
  try{
    await fetch(API+"/vote",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({voter_id:voterId, question_id:qid, option:opt})
    });
    await loadPolls();
    playLastNote(opt);
  }catch(e){console.error(e);}
}

// ----------------------------
// Reset all votes (admin)
// ----------------------------
document.getElementById("resetBtn").onclick = async ()=>{
  const pwd = prompt("Enter admin password:");
  if(!pwd) return;
  try{
    await fetch(API+"/admin/reset",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({password: pwd})
    });
    currentQuestionIndex=0;
    await loadPolls();
    alert("All votes reset!");
  }catch(e){console.error(e);}
}

// ----------------------------
// ABCJS functions
// ----------------------------
function parseABCNote(note){
  const match = note.match(/^([A-Ga-g])(\d)$/);
  if(!match) return null;
  return {pitch: match[1], duration: match[2]};
}
function getNoteBeats(d){
  if(d==="1") return 4;
  if(d==="2") return 2;
  if(d==="4") return 1;
  if(d==="8") return 0.5;
  return 1;
}

function updateMelody(){
  let header =
`X:1
T:Live Melody
M:4/4
L:1/4
Q:1/4=120
K:C
`;
  let body = "";
  let notes = [];
  currentVoteData.forEach(v=>{
    for(let i=0;i<v.count;i++){
      notes.push(v.option);
      body += v.option + " ";
    }
  });
  document.getElementById("notesSequence").textContent = notes.length ? notes.join(" | ") : "No notes yet";
  document.getElementById("abc-notation").innerHTML = "";
  try{
    visualObj = ABCJS.renderAbc("abc-notation", header+body)[0];
  }catch(e){console.error(e);}
}

// Play last voted note
async function playLastNote(note){
  if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
  if(!abcSynth) abcSynth = new ABCJS.synth.CreateSynth();
  try{
    const abcStr =
`X:1
T:Last Note
M:4/4
L:1/4
Q:1/4=120
K:C
` + note;
    visualObj = ABCJS.renderAbc("abc-notation", abcStr)[0];
    await abcSynth.init({visualObj,audioContext});
    await abcSynth.prime();
    abcSynth.start();
  }catch(e){console.error(e);}
}

// ----------------------------
// Show vote results
// ----------------------------
function showResults(){
  const container = document.getElementById("results");
  if(!currentVoteData.length){container.innerHTML="No votes yet"; return;}
  let html="";
  const grouped = {};
  currentVoteData.forEach(v=>{
    if(!grouped[v.question_id]) grouped[v.question_id]=[];
    grouped[v.question_id].push(v);
  });
  Object.keys(grouped).forEach(qid=>{
    html += `<strong>Question ${qid}</strong><br>`;
    grouped[qid].forEach(v=>{html += `${v.option} = ${v.count}<br>`;});
    html+="<br>";
  });
  container.innerHTML = html;
}

// ----------------------------
// Init
// ----------------------------
loadPolls();
setInterval(loadPolls,5000); // live update
</script>

</body>
</html>
