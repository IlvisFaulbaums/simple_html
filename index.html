<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Poll</title>
<style>
body { font-family: Arial; padding: 20px; max-width: 600px; margin: auto; }
h2 { text-align: center; }
button { padding: 8px 15px; margin: 5px; }
#results { margin-top: 20px; }
</style>
</head>
<body>

<h2>Vote on the Poll</h2>
<div id="poll-container"></div>

<h3 id="results">Loading results...</h3>

<script>
const API = "https://api.sarunas.lat"; // Your Worker URL

// Generate a random voter ID for simplicity (or use login/session)
let voterId = localStorage.getItem("voterId");
if (!voterId) {
  voterId = 'voter_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  localStorage.setItem("voterId", voterId);
}

// Load questions dynamically
async function loadQuestions() {
  const res = await fetch(API + "/results");
  const data = await res.json();

  // Group by question
  const questions = {};
  data.forEach(item => {
    if (!questions[item.question_id]) questions[item.question_id] = [];
    questions[item.question_id].push(item.option);
  });

  const container = document.getElementById("poll-container");
  container.innerHTML = "";

  for (const qid in questions) {
    const div = document.createElement("div");
    div.innerHTML = `<h3>${qid}</h3>`; // or you can replace qid with actual question text if CSV has text
    questions[qid].forEach(opt => {
      const btn = document.createElement("button");
      btn.innerText = opt;
      btn.onclick = () => vote(qid, opt);
      div.appendChild(btn);
    });
    container.appendChild(div);
  }

  loadResults();
}

// Vote function
async function vote(questionId, option) {
  const res = await fetch(API + "/vote", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ voter_id: voterId, question_id: questionId, option })
  });

  const data = await res.json();
  if (data.error) alert(data.error);
  loadResults();
}

// Load live results
async function loadResults() {
  const res = await fetch(API + "/results");
  const data = await res.json();

  // Group results by question
  const grouped = {};
  data.forEach(v => {
    if (!grouped[v.question_id]) grouped[v.question_id] = [];
    grouped[v.question_id].push(v);
  });

  let text = "";
  for (const qid in grouped) {
    text += qid + ": ";
    grouped[qid].forEach(o => { text += `${o.option}=${o.count} | `; });
    text += "\n";
  }
  document.getElementById("results").innerText = text;
}

// Auto-refresh every 5 seconds
setInterval(loadResults, 5000);

// Initial load
loadQuestions();
</script>
</body>
</html>
