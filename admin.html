<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
body { font-family: Arial; padding: 20px; max-width: 800px; margin: auto; }
input, button { padding: 8px 12px; margin: 5px; }
table { border-collapse: collapse; width: 100%; margin-top: 15px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
button.reset { background: #f44336; color: white; border: none; cursor: pointer; border-radius: 6px; }
</style>
</head>
<body>

<h2>Admin Dashboard</h2>

<div id="login">
  <input type="password" id="password" placeholder="Enter admin password">
  <button onclick="login()">Login</button>
</div>

<div id="dashboard" style="display:none;">
  <button class="reset" onclick="resetVotes()">Reset All Votes</button>
  <div id="results"></div>
</div>

<script>
const API = "https://api.sarunas.lat"; // Worker URL
let password = "";

// Login
async function login() {
  password = document.getElementById("password").value.trim();
  if (!password) { alert("Enter password"); return; }

  const res = await fetch(API + "/admin/login", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({password})
  });

  const data = await res.json();
  if (!data.success) { alert("Invalid password"); return; }

  document.getElementById("login").style.display = "none";
  document.getElementById("dashboard").style.display = "block";
  loadResults();
}

// Load votes dynamically
async function loadResults() {
  const res = await fetch(API + "/admin/results", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({password})
  });
  const data = await res.json();
  if (data.error) { alert(data.error); return; }

  // Group votes by question
  const grouped = {};
  data.forEach(v => {
    if (!grouped[v.question_id]) grouped[v.question_id] = [];
    grouped[v.question_id].push(v);
  });

  let html = "";
  Object.keys(grouped).forEach(qid => {
    html += `<h3>Question: ${qid}</h3>`;
    html += "<table><tr><th>Option</th><th>Votes</th></tr>";
    grouped[qid].forEach(opt => {
      html += `<tr><td>${opt.option}</td><td>${opt.count}</td></tr>`;
    });
    html += "</table>";
  });

  document.getElementById("results").innerHTML = html;
}

// Reset votes and reload from CSV
async function resetVotes() {
  if (!confirm("Reset all votes and questions?")) return;
  const res = await fetch(API + "/admin/reset", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({password})
  });

  const data = await res.json();
  if (data.success) { alert(data.message); loadResults(); }
  else alert(data.error);
}

// Auto-refresh every 5 seconds
setInterval(() => { if (password) loadResults(); }, 5000);
</script>
</body>
</html>
